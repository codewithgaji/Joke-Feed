{% block content %} {% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jokes - Laugh Out Loud!</title>
    <link rel="stylesheet" href="{% static 'css/index.css' %}" />
    <link rel="icon" href="{% static 'images/jokefeed1.png' %}" type="image/png">
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo">üòÇ Jokes</div>
        <div class="nav-buttons">
          <button class="nav-btn add-joke-btn" onclick="openModal()">
            + Add Joke
          </button>
          <a href="{% url 'about' %}"
            ><button class="nav-btn">Creator üë®‚Äçüíª</button></a
          >
          <a href="{% url 'landingpage' %}"
            ><button class="nav-btn logout-btn" onclick="logout()">
              Logout
            </button></a
          >
        </div>
      </div>
    </nav>

    <div class="main-container">
      <!-- The on-screen message box for feedback -->
      <div id="messageBox" class="message-box"></div>
      
      <div class="joke-container" id="jokeContainer">
        <div class="joke-content" id="jokeContent">
          <div class="no-jokes" id="noJokes">Loading amazing jokes... üòÑ</div>
        </div>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-control-btn" onclick="previousJoke()">
          ‚Üê Previous
        </button>
        <button class="nav-control-btn" onclick="nextJoke()">Next ‚Üí</button>
      </div>
    </div>

    <!-- Add Joke Modal -->
    <div id="addJokeModal" class="modal">
      <div class="modal-content">
        <h2>Add a New Joke</h2>
        <form id="addJokeForm">
          <textarea
            id="jokeInput"
            placeholder="Share your funniest joke..."
            required
          ></textarea>
          <div class="modal-buttons">
            <button
              type="button"
              class="modal-btn cancel-btn"
              onclick="closeModal()"
            >
              Cancel
            </button>
            <button type="submit" class="modal-btn submit-btn">
              Post Joke
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      let currentJokes = [];
      let currentJokeIndex = 0;
      let autoNextTimer = null;
      let timerDisplay = null;
      let userVoted = {}; // Tracks which jokes the user has voted on

      // Initialize the app
      document.addEventListener("DOMContentLoaded", function () {
        checkAuth();
        loadJokes();
      });

      // Check if user is authenticated
      function checkAuth() {
        const token = localStorage.getItem("auth_token");
        if (!token) {
          window.location.href = "/login/";
          return;
        }
      }

      // Load jokes from your Django API
      async function loadJokes() {
        try {
          const response = await fetch("/Added/", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("auth_token")}`,
              "X-CSRFToken": getCookie("csrftoken"),
            },
          });

          if (response.ok) {
            currentJokes = await response.json();
            // Initialize local tracking for user's votes
            currentJokes.forEach(joke => {
                joke.userVoted = null; // 'up', 'down', or null
            });
            if (currentJokes.length > 0) {
              displayCurrentJoke();
              startAutoNext();
              document.querySelector(".navigation-controls").style.display =
                "flex";
            } else {
              showNoJokes();
            }
          } else {
            throw new Error("Failed to load jokes");
          }
        } catch (error) {
          console.error("Error loading jokes:", error);
          showNoJokes();
        }
      }

      // Display current joke with animation
      function displayCurrentJoke() {
        if (currentJokes.length === 0) {
          showNoJokes();
          return;
        }

        const joke = currentJokes[currentJokeIndex];
        const jokeContent = document.getElementById("jokeContent");

        // Fade out current content
        jokeContent.style.opacity = "0";
        jokeContent.style.transform = "translateY(20px)";

        setTimeout(() => {
          jokeContent.innerHTML = `
            <div class="joke-text">${joke.content || joke.text}</div>
            <div class="joke-meta">
              <div class="author">
                <div class="author-avatar">${(
                  joke.created_by ||
                  joke.author ||
                  "Anonymous"
                )
                  .charAt(0)
                  .toUpperCase()}</div>
                <span>by ${
                  joke.created_by || joke.author || "Anonymous"
                }</span>
              </div>
              <div class="date">${formatDate(
                joke.created_at || joke.date
              )}</div>
            </div>
            <div class="vote-buttons">
              <button class="vote-btn upvote-btn ${joke.userVoted === 'up' ? 'voted' : ''}" onclick="vote(event, 'up', ${
                joke.id
              })">
                üëç
              </button>
              <button class="vote-btn downvote-btn ${joke.userVoted === 'down' ? 'voted' : ''}" onclick="vote(event, 'down', ${
                joke.id
              })">
                üëé
              </button>
            </div>
            <div class="joke-stats">
              <div class="stat-item">
                <span>üëç</span>
                <span id="upvotes-${joke.id}">${joke.upvotes || 0}</span>
              </div>
              <div class="stat-item">
                <span>üëé</span>
                <span id="downvotes-${joke.id}">${joke.downvotes || 0}</span>
              </div>
            </div>
            <div class="next-joke-timer" id="timer">
              Next joke in <span id="countdown">7</span>s
            </div>
          `;

          // Fade in new content
          jokeContent.style.opacity = "1";
          jokeContent.style.transform = "translateY(0)";
        }, 300);
      }

      // Vote on a joke
      async function vote(event, type, jokeId) {
        const upvoteElement = document.getElementById(`upvotes-${jokeId}`);
        const downvoteElement = document.getElementById(`downvotes-${jokeId}`);
        const jokeToUpdate = currentJokes.find((joke) => joke.id === jokeId);

        if (!jokeToUpdate) {
          console.error("Joke not found in local data.");
          return;
        }
        
        // **INSTANT FEEDBACK: Check if user has already voted**
        if (jokeToUpdate.userVoted === type) {
            showMessage("You have already voted on this joke!");
            // Do not proceed with the API call
            return;
        }

        // Disable all vote buttons to prevent rapid clicking
        const voteButtons = document.querySelectorAll('.vote-btn');
        voteButtons.forEach(btn => btn.disabled = true);

        // Store original vote counts for potential rollback
        const originalUpvotes = jokeToUpdate.upvotes;
        const originalDownvotes = jokeToUpdate.downvotes;
        const originalUserVoted = jokeToUpdate.userVoted;

        // **OPTIMISTIC UI UPDATE & VOTE TOGGLING LOGIC**
        // Case 1: User is switching their vote (e.g., from up to down)
        if (originalUserVoted && originalUserVoted !== type) {
            if (originalUserVoted === 'up') {
                jokeToUpdate.upvotes = (jokeToUpdate.upvotes || 1) - 1;
            } else {
                jokeToUpdate.downvotes = (jokeToUpdate.downvotes || 1) - 1;
            }
        }
        
        // Case 2: User is casting a new vote
        if (!originalUserVoted || originalUserVoted !== type) {
            if (type === 'up') {
                jokeToUpdate.upvotes = (jokeToUpdate.upvotes || 0) + 1;
            } else {
                jokeToUpdate.downvotes = (jokeToUpdate.downvotes || 0) + 1;
            }
        }
        
        // Update the local state for the user's vote
        jokeToUpdate.userVoted = type;

        // Update the UI immediately to reflect the new counts and button state
        if (upvoteElement) upvoteElement.textContent = jokeToUpdate.upvotes;
        if (downvoteElement) downvoteElement.textContent = jokeToUpdate.downvotes;
        
        // Remove 'voted' class from all buttons and add it to the selected one
        const upvoteButton = document.querySelector(`.upvote-btn`);
        const downvoteButton = document.querySelector(`.downvote-btn`);
        upvoteButton.classList.remove('voted');
        downvoteButton.classList.remove('voted');
        if (type === 'up') upvoteButton.classList.add('voted');
        else downvoteButton.classList.add('voted');

        // Send the vote to the backend
        try {
          const voteType = type === "up" ? "upvote" : "downvote";
          const response = await fetch(`/${jokeId}/${voteType}/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("auth_token")}`,
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ vote_type: voteType }),
          });

          if (response.ok) {
            console.log("Vote successfully registered on the server.");
          } else {
            // Rollback UI if server fails
            jokeToUpdate.upvotes = originalUpvotes;
            jokeToUpdate.downvotes = originalDownvotes;
            jokeToUpdate.userVoted = originalUserVoted;
            if (upvoteElement) upvoteElement.textContent = originalUpvotes;
            if (downvoteElement) downvoteElement.textContent = originalDownvotes;
            upvoteButton.classList.remove('voted');
            downvoteButton.classList.remove('voted');
            if (originalUserVoted === 'up') upvoteButton.classList.add('voted');
            else if (originalUserVoted === 'down') downvoteButton.classList.add('voted');
            
            console.error("Vote failed, reverting UI.");
            const errorData = await response.json();
            showMessage(`Vote failed: ${errorData.detail || "You have already voted on this joke."}`);
          }
        } catch (error) {
            // Rollback UI for network errors
            jokeToUpdate.upvotes = originalUpvotes;
            jokeToUpdate.downvotes = originalDownvotes;
            jokeToUpdate.userVoted = originalUserVoted;
            if (upvoteElement) upvoteElement.textContent = originalUpvotes;
            if (downvoteElement) downvoteElement.textContent = originalDownvotes;
            upvoteButton.classList.remove('voted');
            downvoteButton.classList.remove('voted');
            if (originalUserVoted === 'up') upvoteButton.classList.add('voted');
            else if (originalUserVoted === 'down') downvoteButton.classList.add('voted');

            console.error("Network error, reverting UI:", error);
            showMessage("An error occurred. Please check your connection.");
        } finally {
            // Re-enable vote buttons
            voteButtons.forEach(btn => btn.disabled = false);
            
            // Move to the next joke faster after voting
            clearTimeout(autoNextTimer);
            clearInterval(timerDisplay);
            setTimeout(() => {
                nextJoke();
            }, 1000);
        }
      }

      // Show a message in the custom message box
      function showMessage(message) {
        const messageBox = document.getElementById('messageBox');
        messageBox.textContent = message;
        messageBox.style.display = 'block';
        setTimeout(() => {
            messageBox.style.display = 'none';
        }, 2000); // Hide after 2 seconds
      }

      // Move to next joke
      function nextJoke() {
        currentJokeIndex = (currentJokeIndex + 1) % currentJokes.length;
        displayCurrentJoke();
        startAutoNext();
      }

      // Move to previous joke
      function previousJoke() {
        currentJokeIndex =
          (currentJokeIndex - 1 + currentJokes.length) % currentJokes.length;
        displayCurrentJoke();
        startAutoNext();
      }

      // Start auto-next timer
      function startAutoNext() {
        clearTimeout(autoNextTimer);
        clearInterval(timerDisplay);

        let countdown = 7;
        const countdownElement = document.getElementById("countdown");

        if (countdownElement) {
          countdownElement.textContent = countdown; // Initialize countdown display
          timerDisplay = setInterval(() => {
            countdown--;
            countdownElement.textContent = countdown;

            if (countdown <= 0) {
              clearInterval(timerDisplay);
            }
          }, 1000);
        }

        autoNextTimer = setTimeout(() => {
          nextJoke();
        }, 7000);
      }

      // Show no jokes message
      function showNoJokes() {
        const jokeContent = document.getElementById("jokeContent");
        jokeContent.innerHTML = `
          <div class="no-jokes">
            No jokes available yet! üò¢<br>
            <button class="nav-btn add-joke-btn" onclick="openModal()" style="margin-top: 20px;">
              Be the first to add one! 
            </button>
          </div>
        `;
        // Hide navigation controls if no jokes
        document.querySelector(".navigation-controls").style.display = "none";
        // Also hide the timer, as there's no joke to display it for
        const timerElement = document.getElementById("timer");
        if (timerElement) {
          timerElement.style.display = "none";
        }
      }

      // Format date
      function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 1) return "Yesterday";
        if (diffDays < 7) return `${diffDays} days ago`;
        return date.toLocaleDateString();
      }

      // Modal functions
      function openModal() {
        document.getElementById("addJokeModal").style.display = "block";
        document.getElementById("jokeInput").focus();
      }

      function closeModal() {
        document.getElementById("addJokeModal").style.display = "none";
        document.getElementById("jokeInput").value = "";
      }

      // Handle add joke form submission
      document
        .getElementById("addJokeForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const jokeText = document.getElementById("jokeInput").value.trim();
          if (!jokeText) return;

          const submitBtn = e.target.querySelector(".submit-btn");
          submitBtn.disabled = true;
          submitBtn.textContent = "Posting...";

          try {
            const response = await fetch("/Added/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("auth_token")}`,
                "X-CSRFToken": getCookie("csrftoken"),
              },
              body: JSON.stringify({
                content: jokeText,
              }),
            });

            if (response.ok) {
              const newJoke = await response.json();
              currentJokes.unshift(newJoke); // Add to beginning of array
              closeModal();

              // Show the new joke and restart timer
              currentJokeIndex = 0;
              displayCurrentJoke();
              startAutoNext();
              // Ensure navigation controls are visible if a joke is added after no jokes were present
              document.querySelector(".navigation-controls").style.display =
                "flex";
              document.getElementById("timer").style.display = "block";
            } else {
              throw new Error("Failed to post joke");
            }
          } catch (error) {
            console.error("Error posting joke:", error);
            alert("Failed to post joke. Please try again.");
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "Post Joke";
          }
        });

      // Logout function
      function logout() {
        localStorage.removeItem("auth_token");
        window.location.href = "/login/";
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("addJokeModal");
        if (event.target === modal) {
          closeModal();
        }
      };

      // Fixed Keyboard shortcuts - now checks if user is typing
      document.addEventListener("keydown", function (e) {
        // Check if user is typing in an input field
        const activeElement = document.activeElement;
        const isTyping = activeElement && (
          activeElement.tagName === 'INPUT' || 
          activeElement.tagName === 'TEXTAREA' || 
          activeElement.contentEditable === 'true'
        );
        
        // Don't process shortcuts if user is typing
        if (isTyping) {
          // Allow Escape to close modal even when typing
          if (e.key === "Escape") {
            closeModal();
          }
          return;
        }
        
        // Process shortcuts only when not typing
        if (e.key === "ArrowRight" || e.key === " ") {
          e.preventDefault();
          clearTimeout(autoNextTimer);
          clearInterval(timerDisplay);
          nextJoke();
        }
        if (e.key === "ArrowLeft") {
          e.preventDefault();
          clearTimeout(autoNextTimer);
          clearInterval(timerDisplay);
          previousJoke();
        }
        if (e.key === "Escape") {
          closeModal();
        }
        if (e.key === "n" && e.ctrlKey) {
          e.preventDefault();
          openModal();
        }
      });

      // Get CSRF token function
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
    </script>
  </body>
</html>
{% endblock %}
